/*!
 * chess.js v1.0.0 (https://github.com/JoahG/chess.js)
 * Copyright 2014 Joah Gerstenberg
 * Licensed under MIT License (https://github.com/JoahG/chess.js/blob/master/MIT-LICENSE)
 */
var Board=function(e){this.spaces=new Array,this.turn="white",this.playing_with_fairies=!1,this.log=[],this.move_callback="function"==typeof e?e:void 0;var s=this,i=function(e,s,i){this.hor=e,this.ver=s,this.is_occupied=!1,this.is_guarded=[],this.guarded_by=function(e){return this.is_guarded.filter(function(s){return s.army==e}).length>0},i&&(this.hor=i.hor,this.ver=i.ver,this.is_guarded=i.is_guarded)},t=function(i,t,a){this.type=i,this.space=t,this.army=a,this.possible_moves=function(e){var i=[],t=[],a=[],p=this.space.split("")[0],c=this.space.split("")[1];switch(e?e:this.type){case"pawn":switch(this.army){case"white":s.next(c)&&!s.space_at(p+s.next(c)).is_occupied&&(i.push(p+s.next(c)),"2"!=c||s.space_at(p+s.next(s.next(c))).is_occupied||i.push(p+s.next(s.next(c)))),s.next(p)&&s.next(c)&&(s.space_at(s.next(p)+s.next(c)).is_occupied&&s.space_at(s.next(p)+s.next(c)).is_occupied.army!==this.army&&t.push(s.next(p)+s.next(c)),a.push(s.next(p)+s.next(c))),s.prev(p)&&s.next(c)&&(s.space_at(s.prev(p)+s.next(c)).is_occupied&&s.space_at(s.prev(p)+s.next(c)).is_occupied.army!==this.army&&t.push(s.prev(p)+s.next(c)),a.push(s.prev(p)+s.next(c)));break;case"black":s.prev(c)&&!s.space_at(p+s.prev(c)).is_occupied&&(i.push(p+s.prev(c)),"7"!=c||s.space_at(p+s.prev(s.prev(c))).is_occupied||i.push(p+s.prev(s.prev(c)))),s.next(p)&&s.prev(c)&&(s.space_at(s.next(p)+s.prev(c)).is_occupied&&s.space_at(s.next(p)+s.prev(c)).is_occupied.army!==this.army&&t.push(s.next(p)+s.prev(c)),a.push(s.next(p)+s.prev(c))),s.prev(p)&&s.prev(c)&&(s.space_at(s.prev(p)+s.prev(c)).is_occupied&&s.space_at(s.prev(p)+s.prev(c)).is_occupied.army!==this.army&&t.push(s.prev(p)+s.prev(c)),a.push(s.prev(p)+s.prev(c)))}var r=this.can_en_passant();r&&t.push(r);break;case"bishop":for(var n=p.split()[0],o=c.split()[0];s.next(n)&&s.next(o);){var h=s.next(n)+s.next(o);if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var n=s.next(n),o=s.next(o)}for(var n=p.split()[0],o=c.split()[0];s.next(n)&&s.prev(o);){var h=s.next(n)+s.prev(o);if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var n=s.next(n),o=s.prev(o)}for(var n=p.split()[0],o=c.split()[0];s.prev(n)&&s.next(o);){var h=s.prev(n)+s.next(o);if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var n=s.prev(n),o=s.next(o)}for(var n=p.split()[0],o=c.split()[0];s.prev(n)&&s.prev(o);){var h=s.prev(n)+s.prev(o);if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var n=s.prev(n),o=s.prev(o)}break;case"knight":var n=p.split()[0],o=c.split()[0];if(s.prev(s.prev(n))&&s.prev(o)){var h=s.prev(s.prev(n))+s.prev(o);a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.prev(s.prev(n))&&s.next(o)){var h=s.prev(s.prev(n))+s.next(o);a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.prev(n)&&s.next(s.next(o))){var h=s.prev(n)+s.next(s.next(o));a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.next(n)&&s.next(s.next(o))){var h=s.next(n)+s.next(s.next(o));a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.next(s.next(n))&&s.next(o)){var h=s.next(s.next(n))+s.next(o);a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.next(s.next(n))&&s.prev(o)){var h=s.next(s.next(n))+s.prev(o);a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.next(n)&&s.prev(s.prev(o))){var h=s.next(n)+s.prev(s.prev(o));a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}if(s.prev(n)&&s.prev(s.prev(o))){var h=s.prev(n)+s.prev(s.prev(o));a.push(h),s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h)}break;case"rook":for(var n=p.split("")[0],o=c.split("")[0];s.next(o);){var h=n+s.next(o);if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var o=s.next(o)}for(var n=p.split("")[0],o=c.split("")[0];s.prev(o);){var h=n+s.prev(o);if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var o=s.prev(o)}for(var n=p.split("")[0],o=c.split("")[0];s.next(n);){var h=s.next(n)+o;if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var n=s.next(n)}for(var n=p.split("")[0],o=c.split("")[0];s.prev(n);){var h=s.prev(n)+o;if(a.push(h),s.space_at(h).is_occupied){if(s.space_at(h).is_occupied.army!==this.army){t.push(h);break}if(s.space_at(h).is_occupied)break}else i.push(h);var n=s.prev(n)}break;case"queen":var u=this.possible_moves("bishop"),_=this.possible_moves("rook");i=i.concat(u[0]).concat(_[0]),t=t.concat(u[1]).concat(_[1]),a=a.concat(u[3]).concat(_[3]);break;case"empress":var d=this.possible_moves("knight"),_=this.possible_moves("rook");i=i.concat(d[0]).concat(_[0]),t=t.concat(d[1]).concat(_[1]),a=a.concat(d[3]).concat(_[3]);break;case"unicorn":var d=this.possible_moves("knight"),v=this.possible_moves("queen");i=i.concat(d[0]).concat(v[0]),t=t.concat(d[1]).concat(v[1]),a=a.concat(d[3]).concat(v[3]);break;case"princess":var d=this.possible_moves("knight"),u=this.possible_moves("bishop");i=i.concat(d[0]).concat(u[0]),t=t.concat(d[1]).concat(u[1]),a=a.concat(d[3]).concat(u[3]);break;case"king":var n=p.split()[0],o=c.split()[0],l="white"==this.army?"black":"white";if(s.next(n)){var h=s.next(n)+o;a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.prev(n)){var h=s.prev(n)+o;a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.next(o)){var h=n+s.next(o);a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.prev(o)){var h=n+s.prev(o);a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.next(n)&&s.next(o)){var h=s.next(n)+s.next(o);a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.next(n)&&s.prev(o)){var h=s.next(n)+s.prev(o);a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.prev(n)&&s.prev(o)){var h=s.prev(n)+s.prev(o);a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}if(s.prev(n)&&s.next(o)){var h=s.prev(n)+s.next(o);a.push(h),s.space_at(h).guarded_by(l)||(s.space_at(h).is_occupied?s.space_at(h).is_occupied.army!==this.army&&t.push(h):i.push(h))}this.can_castle("kingside")&&("white"==this.army?i.push("g1"):"black"==this.army&&i.push("g8")),this.can_castle("queenside")&&("white"==this.army?i.push("c1"):"black"==this.army&&i.push("c8"))}return[i,t,i.concat(t),a]},this.can_take=function(e){return this.possible_moves()[1].indexOf(e.space)>-1},this.takes=function(e,s,i){return this.can_take(s)||i&&this.can_move_to(e)?this.move_to(e,s,i):void 0},this.can_move=function(){for(var e=[],s=this.possible_moves()[2],i=0;i<s.length;i+=1)this.can_move_to(s[i],!0)&&e.push(s[i]);return e.length>0},this.can_move_to=function(e,i){var t=!1;if(i||this.possible_moves()[2].indexOf(e)>-1){t=!0,s.space_at(this.space).is_occupied=!1;var a=this.space,p=s.space_at(e).is_occupied;this.space=e,s.space_at(e).is_occupied=this;var c=s.kings_in_check();t="white"==this.army&&c[0]||"black"==this.army&&c[1]?!1:!0,s.space_at(this.space).is_occupied=p,this.space=a,s.space_at(this.space).is_occupied=this}return t},this.move_to=function(i,t,a){if(this.can_move_to(i)){if(a&&!s.space_at(i).is_occupied&&(s.space_at(t.is_occupied.space).is_occupied=!1),"king"==this.type){if("g"==i.split("")[0]&&this.can_castle("kingside"))var p="kingside";else if("c"==i.split("")[0]&&this.can_castle("queenside"))var p="queenside"}else var p=!1;var c=this.space,r=i;if(this.force_move_to(i),"pawn"==this.type&&("white"==this.army&&"8"==r.split("")[1]||"black"==this.army&&"1"==r.split("")[1])){var n,o=!0;if(s.playing_with_fairies)for(;isNaN(parseInt(n))&&-1==[0,1,2,3,4,5,6,7].indexOf(parseInt(n));)n=prompt("Pawn has reached the king row. Pawn may now be promoted to any of the following pieces (Input corresponding number for choice): \n  - 0: Pawn (stay the same) \n  - 1: Bishop \n  - 2: Knight \n  - 3: Rook \n  - 4: Queen \n  - 5: Empress (knight + rook) \n  - 6: Princess (knight + bishop) \n  - 7: Unicorn (knight + queen)");else for(;isNaN(parseInt(n))&&-1==[0,1,2,3,4].indexOf(parseInt(n));)n=prompt("Pawn has reached the king row. Pawn may now be promoted to any of the following pieces (Input corresponding number for choice): \n  - 0: Pawn (stay the same) \n  - 1: Bishop \n  - 2: Knight \n  - 3: Rook \n  - 4: Queen");var h=this.type,u=["pawn","bishop","knight","rook","queen","empress","princess","unicorn"][n];this.type=u}else var o=!1;var _=s.kings_in_check();if("kingside"==p?s.space_at(s.next(this.space.split("")[0])+this.space.split("")[1]).is_occupied.force_move_to(s.prev(this.space.split("")[0])+this.space.split("")[1]):"queenside"==p&&s.space_at(s.prev(s.prev(this.space.split("")[0]))+this.space.split("")[1]).is_occupied.force_move_to(s.next(this.space.split("")[0])+this.space.split("")[1]),p)var d=s.loggify({type:"castle",side:p,from:c,to:r,piece:this,check:"white"==this.army?_[1]:"black"==this.army?_[0]:!1,pawn_promotion:o,old_type:h?h:this.type});else if(t)var d=s.loggify({type:"capture",from:c,to:r,piece:this,cap_piece:t,check:"white"==this.army?_[1]:"black"==this.army?_[0]:!1,pawn_promotion:o,old_type:h?h:this.type});else var d=s.loggify({type:"move",from:c,to:r,piece:this,check:"white"==this.army?_[1]:"black"==this.army?_[0]:!1,pawn_promotion:o,old_type:h?h:this.type});return s.turn="white"==s.turn?"black":"white",e&&s.move_callback(d),!0}return!1},this.force_move_to=function(e){var i=this.possible_moves()[2];s.space_at(this.space).is_occupied=!1,this.space=e,s.space_at(this.space).is_occupied=this;for(var t=0;t<i.length;t+=1)s.space_at(i[t]).is_guarded=s.space_at(i[t]).is_guarded.filter(function(e){return e!==this});for(var i=this.possible_moves()[3],t=0;t<i.length;t+=1)s.space_at(i[t]).is_guarded.push(this);return!0},this.can_castle=function(e){var i="white"==this.army?"black":"white";if("king"==this.type)if("white"==this.army&&0==s.log.filter(function(e){return"e1"==e[1].to||"e1"==e[1].from}).length){if("kingside"==e&&s.space_at("h1").is_occupied&&0==s.log.filter(function(e){return"h1"==e[1].to||"h1"==e[1].from}).length){if(!(s.space_at("f1").is_occupied||s.space_at("g1").is_occupied||s.space_at("e1").guarded_by(i)||s.space_at("f1").guarded_by(i)||s.space_at("g1").guarded_by(i)))return!0}else if("queenside"==e&&s.space_at("a1").is_occupied&&0==s.log.filter(function(e){return"a1"==e[1].to||"a1"==e[1].from}).length&&!(s.space_at("b1").is_occupied||s.space_at("c1").is_occupied||s.space_at("d1").is_occupied||s.space_at("e1").guarded_by(i)||s.space_at("d1").guarded_by(i)||s.space_at("c1").guarded_by(i)))return!0}else if("black"==this.army&&0==s.log.filter(function(e){return"e8"==e[1].to||"e8"==e[1].from}).length)if("kingside"==e&&s.space_at("h8").is_occupied&&0==s.log.filter(function(e){return"h8"==e[1].to||"h8"==e[1].from}).length){if(!(s.space_at("f8").is_occupied||s.space_at("g8").is_occupied||s.space_at("e8").guarded_by(i)||s.space_at("f8").guarded_by(i)||s.space_at("g8").guarded_by(i)))return!0}else if("queenside"==e&&s.space_at("a8").is_occupied&&0==s.log.filter(function(e){return"a8"==e[1].to||"a8"==e[1].from}).length&&!(s.space_at("b8").is_occupied||s.space_at("c8").is_occupied||s.space_at("d8").is_occupied||s.space_at("e8").guarded_by(i)||s.space_at("d8").guarded_by(i)||s.space_at("c8").guarded_by(i)))return!0;return!1},this.can_en_passant=function(){if("pawn"==this.type&&s.log.length>0){var e=s.log[s.log.length-1][1];if(e.to.split("")[0]==s.next(this.space.split("")[0])||e.to.split("")[0]==s.prev(this.space.split("")[0]))if("white"==this.army&&"5"==this.space.split("")[1]){if("pawn"==e.piece.type&&"7"==e.from.split("")[1]&&"5"==e.to.split("")[1]&&e.from.split("")[0]==e.to.split("")[0])return e.from.split("")[0]+s.next(e.to.split("")[1])}else if("black"==this.army&&"4"==this.space.split("")[1]&&"pawn"==e.piece.type&&"2"==e.from.split("")[1]&&"4"==e.to.split("")[1]&&e.from.split("")[0]==e.to.split("")[0])return e.from.split("")[0]+s.prev(e.to.split("")[1])}return!1},this.move_is_en_passant=function(e){return this.can_en_passant()&&!s.space_at(e).is_occupied&&(s.space_at(e.split("")[0]+s.prev(e.split("")[1])).is_occupied&&"pawn"==s.space_at(e.split("")[0]+s.prev(e.split("")[1])).is_occupied.type||s.space_at(e.split("")[0]+s.next(e.split("")[1])).is_occupied&&"pawn"==s.space_at(e.split("")[0]+s.next(e.split("")[1])).is_occupied.type)?s.space_at(e.split("")[0]+("white"==this.army?s.prev(e.split("")[1]):s.next(e.split("")[1]))):!1},this.update_guard=function(){for(var e=this.possible_moves()[3],i=0;i<e.length;i+=1)s.space_at(e[i]).is_guarded.push(this)},this.init=function(){s.space_at(this.space).is_occupied=this},this.init()},a=function(e,s){return this.pieces=[],this.in_check=!1,this.init=function(){if("white"==e)var i=s?s:[["pawn","a2"],["pawn","b2"],["pawn","c2"],["pawn","d2"],["pawn","e2"],["pawn","f2"],["pawn","g2"],["pawn","h2"],["rook","a1"],["knight","b1"],["bishop","c1"],["queen","d1"],["king","e1"],["bishop","f1"],["knight","g1"],["rook","h1"]];else if("black"==e)var i=s?s:[["pawn","a7"],["pawn","b7"],["pawn","c7"],["pawn","d7"],["pawn","e7"],["pawn","f7"],["pawn","g7"],["pawn","h7"],["rook","a8"],["knight","b8"],["bishop","c8"],["queen","d8"],["king","e8"],["bishop","f8"],["knight","g8"],["rook","h8"]];if(!i)return!1;for(var a=0;a<i.length;a+=1)p=i[a],this.pieces.push(new t(p[0],p[1],e))},this.init(),!0};this.space_at=function(e){for(var s=e.split("")[0],i=e.split("")[1],t=0;t<this.spaces.length;t+=1)if(j=this.spaces[t],j.hor==s&&j.ver==i)return j},this.update_guards=function(){for(var e=this.spaces,s=0;s<e.length;s+=1)e[s].is_guarded=[];for(var s=0;s<e.length;s+=1)e[s].is_occupied&&e[s].is_occupied.update_guard()},this.kings_in_check=function(e){for(var i=s.spaces.filter(function(e){return"king"==e.is_occupied.type}),t=void 0,a=void 0,p=0;p<i.length;p+=1)"white"==i[p].is_occupied.army?t=i[p].is_occupied.space:"black"==i[p].is_occupied.army&&(a=i[p].is_occupied.space);s.update_guards();var c=[s.space_at(t).guarded_by("black"),s.space_at(a).guarded_by("white")];return e?"white"==e?c[0]:"black"==e?c[1]:!1:c},this.is_checkmate=function(e){for(var i=s.spaces.filter(function(s){return s.is_occupied.army==e}),t=0;t<i.length;t+=1)for(var a=i[t].is_occupied,p=i[t].is_occupied.possible_moves()[2],c=0;c<p.length;c+=1)if(a.can_move_to(p[c]))return!1;return!0},this.loggify=function(e){var i=e.piece.type.toLowerCase();i="knight"==i?"N":"bishop"==i?"B":"rook"==i?"R":"queen"==i?"Q":"king"==i?"K":"empress"==i?"E":"princess"==i?"P":"Unicorn"==i?"U":"";var t=e.old_type.toLowerCase();t="knight"==t?"N":"bishop"==t?"B":"rook"==t?"R":"queen"==t?"Q":"king"==t?"K":"empress"==t?"E":"princess"==t?"P":"Unicorn"==t?"U":"";var a="";if(e.check&&(a=s.is_checkmate("white"==e.piece.army?"black":"white")?"#":"+"),e.pawn_promotion){if("move"==e.type)var p=[t+e.to+"="+i+a,e];else if("capture"==e.type){t=""==t?e.from[0]:t;var p=[t+"x"+e.to+"="+i+a,e]}}else if("move"==e.type)var p=[i+e.to+a,e];else if("capture"==e.type){i=""==i?e.from[0]:i;var p=[i+"x"+e.to+a,e]}else if("castle"==e.type){i="O-O"+("queenside"==e.side?"-O":"");var p=[i,e]}return s.log.push(p),s.is_checkmate("white"==e.piece.army?"black":"white")&&(s.log.length%2==1&&s.log.push(["",e]),"white"==e.piece.army?s.log.push(["1-0",e]):"black"==e.piece.army&&s.log.push(["0-1",e])),p},this.prev=function(e){if(parseInt(e,10)){if("1"!==e)return(parseInt(e,10)-1).toString()}else if("abcdefgh".split("").indexOf(e)>-1&&"a"!==e)return l="abcdefgh".split(""),l[l.indexOf(e)-1];return!1},this.next=function(e){if(parseInt(e,10)){if("8"!==e)return(parseInt(e,10)+1).toString()}else if("abcdefgh".split("").indexOf(e)>-1&&"h"!==e)return l="abcdefgh".split(""),l[l.indexOf(e)+1];return!1},this.restore=function(e){this.turn=e.turn,this.black=e.black,this.white=e.white,this.log=e.log,this.playing_with_fairies=e.playing_with_fairies,this.spaces=[],sps=JSON.parse(JSON.stringify(e.spaces));for(var a=0;a<sps.length;a+=1)if(this.spaces.push(new i("","",sps[a])),sps[a].is_occupied){var p=sps[a].is_occupied;this.spaces[a].is_occupied=new t(p.type,p.space,p.army,s)}},this.export=function(){return JSON.stringify(this)},this.init=function(){for(var e="abcdefgh".split(""),s="12345678".split(""),t=0;t<e.length;t+=1)for(var p=e[t],c=0;c<s.length;c+=1){var r=s[c];this.spaces.push(new i(p,r))}this.log=[],this.white=new a("white"),this.black=new a("black")},this.init()};